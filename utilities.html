<html>
<head>
	<title>declab - Utilities</title>
	<meta charset="UTF-8">
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/uuid@latest/dist/umd/uuidv4.min.js"></script>
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,700|Source+Code+Pro:400">
	<style>
		body {
			font-family: "PT Sans", sans-serif;
			margin: 0;
			background: #f6f6f8;
			min-height: 100vh;
			display: flex;
			justify-content: center;
			align-items: center;
		}

		h1, h2, h3 {
			margin: 0 0 0.5rem 0;
		}

		code {
			font-family: "Source Code Pro", monospace;
			font-size: .85rem;
		}

		#app {
			width: 1000px;
			display: flex;
		}

		.container.left {
			flex: 1;
			margin-right: 1rem;
		}

		.container.right {
			flex: 1;
		}

		.card {
			position: relative;
			background: #fff;
			border: 1px solid rgba(0, 0, 0, .125);
			border-radius: 0.25rem;
			box-shadow: 0 0 20px 0 rgba(117, 202, 136, .12);
			padding: 1.25rem;
			margin-bottom: 2rem
		}

		.card:last-child {
			margin-bottom: 0;
		}

		.console {
			background: #000;
			border-radius: 0.25rem;
			color: #fff;
			padding: 1.25rem;
		}

		.console code {
			display: block;
		}
	</style>
</head>
<body>
<div id="app">
	<div class="container left">
		<h1>Conversions</h1>
		<h2>DMN 1.1 (ACTICO) to DMN 1.2 (Kogito)</h2>
		<div class="card" v-on:drop="onDrop($event, 2)" v-on:dragover="onDrag" v-on:dragenter="onDrag">
			<code>Drag and drop models here!</code>
		</div>
		<h2>DMN 1.2 (Kogito) to DMN 1.1 (ACTICO)</h2>
		<div class="card" v-on:drop="onDrop($event, 1)" v-on:dragover="onDrag" v-on:dragenter="onDrag">
			<code>Drag and drop models here!</code>
		</div>

		<h1>Fixes</h1>
		<h2>ACTICO Decision Service</h2>
		<div class="card" v-on:drop="onDrop($event, 3)" v-on:dragover="onDrag" v-on:dragenter="onDrag">
			<code>Drag and drop models here!</code>
		</div>
	</div>
	<div class="container right">
		<h1>Logs</h1>
		<div class="console">
			<code v-for="log of logs">{{log}}</code>
		</div>
	</div>
</div>
<script>
	var app = new Vue({
		el: '#app',
		data: {
			logs: []
		},
		methods: {
			// Listeners
			onDrag(e) {
				e.preventDefault(); // See https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API/Drag_operations#droptargets.
			},
			async onDrop(e, target) {
				e.preventDefault();

				this.logs = [];

				const files = e.dataTransfer.files;
				if (files.length !== 1) {
					return;
				}

				const file = files[0];
				const content = await new Promise(resolve => {
					const fileReader = new FileReader();
					fileReader.addEventListener("load", async function (readerEvent) {
						resolve(readerEvent.target.result);
					});
					fileReader.readAsText(file, "UTF-8");
				});

				this.logs.push("File " + file.name + " was imported.");

				const downloadElement = document.createElement("a");
				downloadElement.href = URL.createObjectURL(new Blob([this.processModel(content, target)], {type: 'text/xml'}));
				downloadElement.download = file.name;
				downloadElement.click();

				this.logs.push("File " + file.name + " was exported.");
			},
			/*
			The following targets are supported:
			1: DMN 1.2 (Kogito) to DMN 1.1 (ACTICO)
			2: DMN 1.1 (ACTICO) to DMN 1.2 (Kogito)
			3: ACTICO Decision Service Fix
			 */
			processModel(content, target) {
				// Reference: https://github.com/materna-se/jdec/blob/master/src/main/java/de/materna/jdec/dmn/conversions/ActicoConverter.java.
				switch (target) {
					case 1:
					case 2: {
						let rootElement = this.deserializeModel(this.updateModelVersion(content, target));

						this.updateDataTypes(rootElement, target);
						this.convertLayout(rootElement, target);

						if (target === 2) {
							this.fixActicoDecisionServices(rootElement);
						}

						if (target === 2) {
							this.fixActicoFunctionDefinition(rootElement);
						}

						return this.serializeModel(rootElement);
					}
					case 3: {
						let rootElement = this.deserializeModel(content);
						this.fixActicoDecisionServices(rootElement);
						return this.serializeModel(rootElement);
					}
				}
			},

			// Helpers

			deserializeModel(content) {
				return (new DOMParser()).parseFromString(content, "application/xml").children[0];
			},
			serializeModel(rootElement) {
				return (new XMLSerializer()).serializeToString(rootElement);
			},

			// Conversions

			/**
			 * Updates the dmn: and feel: namespace URI between DMN 1.1 and DMN 1.2.
			 */
			updateModelVersion(content, target) {
				// This needs to be done before parsing, because it is not possible to change the namespace URI afterwards.
				// See https://developer.mozilla.org/en-US/docs/Web/API/Element/namespaceURI.
				content = content.replace(/xmlns:dmn="(.*?)"/, function (match, first) {
					switch (target) {
						case 1:
							return "xmlns:dmn=\"http://www.omg.org/spec/DMN/20151101/dmn.xsd\"";
						case 2:
							return "xmlns:dmn=\"http://www.omg.org/spec/DMN/20180521/MODEL/\"";
					}
					this.logs.push("DMN version was updated.");
				});
				content = content.replace(/xmlns:feel="(.*?)"/, function (match, first) {
					switch (target) {
						case 1:
							return "xmlns:feel=\"http://www.omg.org/spec/FEEL/20140401\"";
						case 2:
							return "xmlns:feel=\"http://www.omg.org/spec/DMN/20180521/FEEL/\"";
					}
					this.logs.push("FEEL version was updated.");
				});
				return content;
			},
			/**
			 * Converts feel:* to * in DMN 1.1 to DMN 1.2 conversions and * to feel:* in DMN 1.2 to DMN 1.1 conversions.
			 */
			updateDataTypes(rootElement, target) {
				for (const typeElement of rootElement.querySelectorAll("[typeRef]")) {
					switch (target) {
						case 1: {
							const oldType = typeElement.getAttribute("typeRef");
							typeElement.setAttribute("typeRef", "feel:" + typeElement.getAttribute("typeRef"));
							this.logs.push("Type " + oldType + " was converted to " + typeElement.getAttribute("typeRef") + ".");
							break;
						}
						case 2: {
							if (typeElement.innerHTML.startsWith("feel:")) {
								const oldType = typeElement.getAttribute("typeRef");
								typeElement.setAttribute("typeRef", typeElement.getAttribute("typeRef").substring(5));
								this.logs.push("Type " + oldType + " was converted to " + typeElement.getAttribute("typeRef") + ".");
							}
							break;
						}
					}
				}
				for (const typeElement of rootElement.querySelectorAll("*")) {
					switch (target) {
						case 1:
							// "If the type language is FEEL the built-in types are the FEEL built-in data types: number, string, boolean, days and time duration, years and months duration, time, and date and time. A typeRef referencing a built-in type SHALL omit the prefix." (https://www.omg.org/spec/DMN/1.2/PDF)
							if (/^(number|string|boolean|days and time duration|years and months duration|time|date and time)/.test(typeElement.innerHTML)) {
								const oldType = typeElement.innerHTML;
								typeElement.innerHTML = "feel:" + typeElement.innerHTML;
								this.logs.push("Type " + oldType + " was converted to " + typeElement.innerHTML + ".");
							}
							break;
						case 2:
							if (typeElement.innerHTML.startsWith("feel:")) {
								const oldType = typeElement.innerHTML;
								typeElement.innerHTML = typeElement.innerHTML.substring(5);
								this.logs.push("Type " + oldType + " was converted to " + typeElement.innerHTML + ".");
							}
							break;
					}
				}
			},
			/**
			 * Converts the layout between the ACTICO and Kogito format.
			 * @todo
			 */
			convertLayout(rootElement, target) {
				switch (target) {
					case 1:
						// TODO:
						Array.from(rootElement.getElementsByTagName("dmndi:DMNDI")).forEach(element => {
							element.remove();
							this.logs.push("Diagram interchange element was removed.");
						});
						break;
					case 2:
						Array.from(rootElement.getElementsByTagName("dmn:extensionElements")).forEach(element => {
							element.remove();
							this.logs.push("Extension element was removed.");
						});
						break;
				}
			},

			// Fixes

			/**
			 * Adds the required variable tag to decision services.
			 * ACTICO omits the tag and thus creates models that are not compliant with the DMN specification.
			 */
			fixActicoDecisionServices(rootElement) {
				for (const decisionServiceElement of rootElement.getElementsByTagName("dmn:decisionService")) {
					if (decisionServiceElement.getElementsByTagName("dmn:variable").length === 0) {
						const variableElement = document.createElementNS("http://www.omg.org/spec/DMN/20180521/MODEL/", "dmn:variable");
						variableElement.setAttribute("id", "_" + uuidv4());
						variableElement.setAttribute("name", decisionServiceElement.getAttribute("name"));
						decisionServiceElement.appendChild(variableElement);

						this.logs.push("ACTICO Decision Service " + decisionServiceElement.getAttribute("name") + " was fixed.");
					}
				}
			},
			fixActicoFunctionDefinition(rootElement) {
				for (const functionDefinitionElement of rootElement.querySelectorAll("functionDefinition, encapsulatedLogic")) {
					if(functionDefinitionElement.getAttribute("kind") === null) {
						functionDefinitionElement.setAttribute("kind", "FEEL");
						this.logs.push("ACTICO Function Definition " + functionDefinitionElement.getAttribute("id") + " was fixed.");
					}
				}
			}
		}
	})
</script>
</body>
</html>